# Plan: Generate preamble constants from constants.py

## Summary

Replace the hardcoded constant literals in `_CLIENT_PREAMBLE` with
programmatic generation from `dnsdle.constants`, eliminating silent-drift
risk between the assembled client and the canonical constant definitions.
Add client exit codes to `constants.py` so they participate in the same
mechanism.  `ClientError` / `RetryableTransport` class duplication between
the preamble and the `client_runtime.py` development header is inherently
necessary and left unchanged.

## Problem

Every constant in `_CLIENT_PREAMBLE` (36 values across DNS wire, payload,
mapping, exit code, and runtime tuning groups) is a hand-written literal
copy of a value already defined in `constants.py`.  If someone updates
`constants.py` and forgets the preamble, the development-context and
assembled-client behaviors silently diverge.

The runtime tuning constants are triplicated: canonical values in
`constants.py` (`GENERATED_CLIENT_DEFAULT_*`), hardcoded literals in
`_CLIENT_PREAMBLE`, and auto-synced aliases in the `client_runtime.py`
development header.  Only the dev-header aliases stay in sync automatically.

The `EXIT_*` constants and `ClientError`/`RetryableTransport` classes are
duplicated between the preamble and the development header.  The class
duplication is inherently necessary (the preamble needs the definitions for
the assembled client; the dev header needs them for importability).  The
`EXIT_*` integer constants, however, can be sourced from `constants.py`
like all other constants.

## Goal

1. Every constant value in the assembled client preamble is read from
   `constants.py` at assembly time -- no hand-written literal copies.
2. Client exit codes live in `constants.py` alongside all other constants.
3. The `client_runtime.py` development header imports exit codes from
   `constants.py` instead of hardcoding them.
4. The assembled standalone client is functionally equivalent (same names,
   same values, compiles, passes smoke tests).
5. `ClientError` / `RetryableTransport` class definitions remain in both
   the preamble and the development header (inherently necessary; accepted
   duplication).

## Design

### 1. Add client exit codes to `constants.py`

Add six constants under a `CLIENT_EXIT_` prefix:

```python
CLIENT_EXIT_USAGE = 2
CLIENT_EXIT_TRANSPORT = 3
CLIENT_EXIT_PARSE = 4
CLIENT_EXIT_CRYPTO = 5
CLIENT_EXIT_REASSEMBLY = 6
CLIENT_EXIT_WRITE = 7
```

### 2. Split the preamble and generate constants programmatically

Replace the single `_CLIENT_PREAMBLE` string with three parts assembled
in `build_client_source()`:

- `_PREAMBLE_HEADER`: shebang, coding declaration, `from __future__`,
  stdlib imports (static string, ~17 lines).
- Generated constants block: all 36 constant assignments formatted from
  `dnsdle.constants` using `repr()` for values.
- `_PREAMBLE_FOOTER`: PY2/type detection `try`/`except`, `ClientError`,
  `RetryableTransport`, `DnsParseError` (static string, ~17 lines).

The constants block is generated by a module-level tuple of
`(preamble_name, constants_attribute_name)` pairs:

```python
from dnsdle import constants as _c

# (name in assembled client, attribute name in dnsdle.constants)
_PREAMBLE_CONSTANTS = (
    # DNS wire
    ("DNS_FLAG_QR", "DNS_FLAG_QR"),
    ("DNS_FLAG_TC", "DNS_FLAG_TC"),
    ("DNS_FLAG_RD", "DNS_FLAG_RD"),
    ("DNS_OPCODE_QUERY", "DNS_OPCODE_QUERY"),
    ("DNS_OPCODE_MASK", "DNS_OPCODE_MASK"),
    ("DNS_QTYPE_A", "DNS_QTYPE_A"),
    ("DNS_QTYPE_CNAME", "DNS_QTYPE_CNAME"),
    ("DNS_QTYPE_OPT", "DNS_QTYPE_OPT"),
    ("DNS_QCLASS_IN", "DNS_QCLASS_IN"),
    ("DNS_HEADER_BYTES", "DNS_HEADER_BYTES"),
    ("DNS_POINTER_TAG", "DNS_POINTER_TAG"),
    ("DNS_POINTER_VALUE_MASK", "DNS_POINTER_VALUE_MASK"),
    ("DNS_RCODE_NOERROR", "DNS_RCODE_NOERROR"),
    # payload
    ("PAYLOAD_PROFILE_V1_BYTE", "PAYLOAD_PROFILE_V1_BYTE"),
    ("PAYLOAD_FLAGS_V1_BYTE", "PAYLOAD_FLAGS_V1_BYTE"),
    ("PAYLOAD_MAC_TRUNC_LEN", "PAYLOAD_MAC_TRUNC_LEN"),
    ("PAYLOAD_ENC_KEY_LABEL", "PAYLOAD_ENC_KEY_LABEL"),
    ("PAYLOAD_ENC_STREAM_LABEL", "PAYLOAD_ENC_STREAM_LABEL"),
    ("PAYLOAD_MAC_KEY_LABEL", "PAYLOAD_MAC_KEY_LABEL"),
    ("PAYLOAD_MAC_MESSAGE_LABEL", "PAYLOAD_MAC_MESSAGE_LABEL"),
    # mapping
    ("MAPPING_FILE_LABEL", "MAPPING_FILE_LABEL"),
    ("MAPPING_SLICE_LABEL", "MAPPING_SLICE_LABEL"),
    ("FILE_ID_PREFIX", "FILE_ID_PREFIX"),
    # exit codes
    ("EXIT_USAGE", "CLIENT_EXIT_USAGE"),
    ("EXIT_TRANSPORT", "CLIENT_EXIT_TRANSPORT"),
    ("EXIT_PARSE", "CLIENT_EXIT_PARSE"),
    ("EXIT_CRYPTO", "CLIENT_EXIT_CRYPTO"),
    ("EXIT_REASSEMBLY", "CLIENT_EXIT_REASSEMBLY"),
    ("EXIT_WRITE", "CLIENT_EXIT_WRITE"),
    # runtime tuning
    ("REQUEST_TIMEOUT_SECONDS", "GENERATED_CLIENT_DEFAULT_REQUEST_TIMEOUT_SECONDS"),
    ("NO_PROGRESS_TIMEOUT_SECONDS", "GENERATED_CLIENT_DEFAULT_NO_PROGRESS_TIMEOUT_SECONDS"),
    ("MAX_ROUNDS", "GENERATED_CLIENT_DEFAULT_MAX_ROUNDS"),
    ("MAX_CONSECUTIVE_TIMEOUTS", "GENERATED_CLIENT_DEFAULT_MAX_CONSECUTIVE_TIMEOUTS"),
    ("RETRY_SLEEP_BASE_MS", "GENERATED_CLIENT_DEFAULT_RETRY_SLEEP_BASE_MS"),
    ("RETRY_SLEEP_JITTER_MS", "GENERATED_CLIENT_DEFAULT_RETRY_SLEEP_JITTER_MS"),
    ("QUERY_INTERVAL_MS", "GENERATED_CLIENT_DEFAULT_QUERY_INTERVAL_MS"),
)
```

In `build_client_source()`:

```python
constants_lines = "\n".join(
    "%s = %s" % (name, repr(getattr(_c, attr)))
    for name, attr in _PREAMBLE_CONSTANTS
)
preamble = _PREAMBLE_HEADER + constants_lines + "\n" + _PREAMBLE_FOOTER
```

The spacing contract: `_PREAMBLE_HEADER` ends with `\n\n` (blank line
after the last import).  The generated constants block has no leading or
trailing blank lines.  `_PREAMBLE_FOOTER` starts with `\n` (blank line
before the `try:` block) and ends with `\n\n` (blank line before the
closing `'''` equivalent, matching the current preamble's trailing spacing
for the extract-block join).

The assembled client output will use `repr()` formatting (e.g., `32768`
instead of `0x8000`, `b'...'` instead of `b"..."`).  This is functionally
identical; no byte-compare against the prior output is needed.

### 3. Update client_runtime.py development header

Replace the hardcoded `EXIT_*` lines:

```python
EXIT_USAGE = 2; EXIT_TRANSPORT = 3; EXIT_PARSE = 4
EXIT_CRYPTO = 5; EXIT_REASSEMBLY = 6; EXIT_WRITE = 7
```

With imports from `constants.py`:

```python
from dnsdle.constants import (
    CLIENT_EXIT_USAGE as EXIT_USAGE,
    CLIENT_EXIT_TRANSPORT as EXIT_TRANSPORT,
    CLIENT_EXIT_PARSE as EXIT_PARSE,
    CLIENT_EXIT_CRYPTO as EXIT_CRYPTO,
    CLIENT_EXIT_REASSEMBLY as EXIT_REASSEMBLY,
    CLIENT_EXIT_WRITE as EXIT_WRITE,
)
```

`ClientError` and `RetryableTransport` remain defined locally in the
development header (inherently necessary for importability; accepted
duplication).

### Validation

The assembled client output changes format (repr-style literals) but not
semantics.  Validate with:

```
python -c "import dnsdle.client_standalone as m; src = m.build_client_source(); open('/tmp/preamble_test.py','wb').write(src.encode('ascii'))"
python /tmp/preamble_test.py --help
python /tmp/preamble_test.py --psk x --domains "INVALID DOMAIN" --mapping-seed s --publish-version v --total-slices 1 --compressed-size 1 --sha256 0000000000000000000000000000000000000000000000000000000000000000 --token-len 4 --verbose; echo "exit=$?"
```

## Affected Components

- `dnsdle/constants.py`: add 6 `CLIENT_EXIT_*` constants.
- `dnsdle/client_standalone.py`: replace `_CLIENT_PREAMBLE` with
  `_PREAMBLE_HEADER` + `_PREAMBLE_FOOTER` + `_PREAMBLE_CONSTANTS` tuple;
  update `build_client_source()` to generate constants block; add
  `from dnsdle import constants as _c`.
- `dnsdle/client_runtime.py`: replace hardcoded `EXIT_*` lines with
  imports from `constants.py`.
- `doc/architecture/CLIENT_GENERATION.md`: update Architecture bullet 4
  to note that `build_client_source()` generates the constants section
  programmatically from `constants.py` (no longer a static string literal).
